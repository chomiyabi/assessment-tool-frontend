<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診断結果 - DX Web診断</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="container">
            <h1 class="logo">Haru Automation</h1>
        </div>
    </header>
    
    <!-- サブヘッダー -->
    <section class="sub-header">
        <div class="container">
            <h1 class="sub-header-title">業務改善ポテンシャル診断結果</h1>
        </div>
    </section>
    
    <!-- メインコンテンツ -->
    <main class="main">
        <div class="container">
            <div class="result-content">
                
                <!-- 診断結果サマリー -->
                <div class="result-summary-section">
                    <p class="result-summary-text" id="resultSummary">
                        <!-- 動的に生成される文言: 貴社のAI活用スコアは「XXX」、業務改善ポテンシャルは「YYY」となります。 -->
                        診断結果を計算中...
                    </p>
                </div>
                
                <!-- 業務改善ポテンシャル レーダーチャート -->
                <div class="result-chart-section">
                    <h3 class="chart-title">業務改善ポテンシャルの診断結果</h3>
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- レベル詳細解説 -->
                <div class="level-detail-section">
                    <div class="level-description" id="levelDescription">
                        <!-- 動的に生成される詳細解説 -->
                        <p>診断レベルの詳細解説を読み込み中...</p>
                    </div>
                </div>
                
                <!-- Haru Automationサービス紹介エリア -->
                <div class="service-introduction">
                    <h3 class="service-title">Haru Automation のご紹介</h3>
                    <div class="service-description">
                        <p><strong>生成AIとあらゆるツールを連携させ、"即成果が出る"自動化を実現します。</strong></p>
                        
                        <p>Haru Automationは、ChatGPTやGeminiなどの生成AIと、ZapierやDify、PowerAutomateといった各種効率化ツールを最適に組み合わせ、お客様専用の業務改善フローを構築します。</p>
                        
                        <p>AI単体では実現できなかった、複雑な業務の自動化や品質向上まで、一気通貫でご支援。「面倒」をなくし、企業のコア業務に集中できる環境を創り出します。</p>
                        
                        <p>高額な初期投資は不要です。まずは<strong>29,800円の「お試しプラン」</strong>で、業務の一つを自動化することによるインパクトを体感してください。効果にご納得いただけた上で、本格的なご支援へとステップアップが可能です。</p>
                        
                        <p>導入後の運用も<strong>「丸投げOK」</strong>のサポート体制で、安心してご利用いただけます。</p>
                    </div>
                    <div class="service-cta-buttons">
                        <button class="btn btn-primary" onclick="openServiceDetail()">
                            サービス詳細を見る
                        </button>
                        <button class="btn btn-secondary" onclick="openContactForm()">
                            お問い合わせ
                        </button>
                    </div>
                </div>
                <!-- ナビゲーションエリア -->
                <div class="navigation-section">
                    <div class="navigation-buttons">
                        <button class="btn btn-outline" onclick="restartAssessment()">
                            診断をやり直す
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- フッター -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Haru All Rights Reserved</p>
        </div>
    </footer>
    
    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/app.js"></script>
    <script src="js/api.js?v=4.2.0"></script>
    <script>
        // 診断結果データ
        let resultData = {
            totalScore: 0,
            categoryScores: {},
            answers: {}
        };
        
        // カテゴリマッピング（スプレッドシートのカテゴリに対応）
        const categoryMapping = {
            // スプレッドシートの英語カテゴリ
            'Knowledge': { key: 'knowledge', color: '#4A90E2' },
            'Skill': { key: 'skill', color: '#EC892E' },
            'Idea': { key: 'idea', color: '#27AE60' },
            'Management': { key: 'management', color: '#8E44AD' },
            'HR': { key: 'hr', color: '#E74C3C' },
            'Marketing': { key: 'marketing', color: '#9B59B6' },
            // 日本語カテゴリ（ローカルテスト用）
            '経営': { key: 'management', color: '#4A90E2' },
            '人事': { key: 'hr', color: '#EC892E' },
            'マーケティング': { key: 'marketing', color: '#27AE60' },
            '営業': { key: 'sales', color: '#8E44AD' },
            'IT': { key: 'it', color: '#E74C3C' },
            'Others': { key: 'others', color: '#9B59B6' },
            'その他': { key: 'others', color: '#9B59B6' }
        };
        
        // ページ読み込み時の処理
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('P-05: 診断結果ページが読み込まれました');
            
            // 診断データの確認
            const assessmentAnswers = Common.storage.get('assessmentAnswers');
            const userData = Common.storage.get('userData');
            
            if (!assessmentAnswers || !userData) {
                console.warn('診断データが見つかりません。デモ用サンプルデータを使用します。');
                // デモ用：サンプルデータで処理を継続（本番では削除推奨）
                const sampleAnswers = { Q001: 2, Q002: 3, Q003: 1, Q004: 2, Q005: 3 };
                await calculateResults(sampleAnswers);
                displayResults();
                return;
            }
            
            // APIから結果を取得するか、ローカルで計算
            if (userData.session_id) {
                try {
                    LoadingHelper.show('少々お待ちください');
                    
                    const apiResult = await API.getResult(userData.session_id);
                    console.log('API結果取得成功:', apiResult);
                    
                    // API結果を使用
                    resultData.totalScore = apiResult.total_score;
                    resultData.maturityLevel = apiResult.maturity_level;
                    resultData.categoryScores = apiResult.category_scores || {};
                    resultData.recommendedServices = apiResult.recommended_services || [];
                    
                    // カテゴリスコアを整形（APIから返されたデータをそのまま使用）
                    const categoryScoresTemp = {};
                    Object.keys(resultData.categoryScores).forEach(category => {
                        const score = resultData.categoryScores[category];
                        // カテゴリごとの質問数を計算（実際の質問データから）
                        let categoryQuestionCount = 0;
                        if (apiResult.questions_by_category && apiResult.questions_by_category[category]) {
                            categoryQuestionCount = apiResult.questions_by_category[category];
                        } else {
                            // デフォルトで推定（経営3問、人事1問、マーケティング1問）
                            if (category === '経営') categoryQuestionCount = 3;
                            else if (category === '人事') categoryQuestionCount = 1;
                            else if (category === 'マーケティング') categoryQuestionCount = 1;
                            else categoryQuestionCount = 1;
                        }
                        
                        categoryScoresTemp[category] = {
                            average: score,
                            total: score,
                            count: categoryQuestionCount
                        };
                    });
                    resultData.categoryScores = categoryScoresTemp;
                    
                    LoadingHelper.hide();
                    displayResults();
                    
                } catch (error) {
                    LoadingHelper.hide();
                    console.error('API結果取得エラー:', error);
                    // エラー時はローカル計算
                    await calculateResults(assessmentAnswers);
                    displayResults();
                }
            } else {
                // セッションIDがない場合はローカル計算
                await calculateResults(assessmentAnswers);
                displayResults();
            }
        });
        
        // 結果計算
        async function calculateResults(answers) {
            try {
                // APIから正確な質問データを取得
                const questionData = await API.getQuestions();
                const questions = questionData.questions;
                
                console.log('取得した質問データ:', questions);
                console.log('最初の質問の詳細:', questions[0]);
                
                if (!questions || questions.length === 0) {
                    throw new Error('質問データの取得に失敗しました');
                }
                
                resultData.answers = answers;
                resultData.categoryScores = {};
                
                // カテゴリ別スコア計算（実際のスプレッドシートデータを使用）
                questions.forEach(question => {
                    const answerIndex = answers[question.question_id];
                    console.log(`処理中: ${question.question_id}, 回答インデックス: ${answerIndex}`);
                    
                    if (answerIndex !== null && answerIndex !== undefined && answerIndex >= 0) {
                        // スプレッドシートの実際のスコア値を使用
                        // APIのデータ構造に応じて調整
                        let score = 0;
                        
                        // option_X_scoreフィールドの確認
                        console.log(`${question.question_id}のスコアフィールド:`, {
                            option_1_score: question.option_1_score,
                            option_2_score: question.option_2_score,
                            option_3_score: question.option_3_score,
                            option_4_score: question.option_4_score
                        });
                        
                        // スコアフィールドが数値でない場合は変換
                        switch(answerIndex) {
                            case 0:
                                score = parseInt(question.option_1_score) || 1;
                                break;
                            case 1:
                                score = parseInt(question.option_2_score) || 2;
                                break;
                            case 2:
                                score = parseInt(question.option_3_score) || 3;
                                break;
                            case 3:
                                score = parseInt(question.option_4_score) || 4;
                                break;
                            default:
                                score = 0;
                        }
                        
                        console.log(`${question.question_id}: 選択肢${answerIndex + 1} → スコア${score}`);
                        
                        const category = question.category;
                        
                        if (!resultData.categoryScores[category]) {
                            resultData.categoryScores[category] = {
                                total: 0,
                                count: 0,
                                questions: []
                            };
                        }
                        
                        resultData.categoryScores[category].total += score;
                        resultData.categoryScores[category].count += 1;
                        resultData.categoryScores[category].questions.push({
                            questionId: question.question_id,
                            score: score
                        });
                    }
                });
                
                // 各カテゴリの平均スコア計算（実際のスコア値をそのまま使用）
                Object.keys(resultData.categoryScores).forEach(category => {
                    const data = resultData.categoryScores[category];
                    data.average = data.total / data.count;
                });
                
                // 総合スコア計算（全スコアの合計）
                let totalScore = 0;
                Object.values(resultData.categoryScores).forEach(categoryData => {
                    totalScore += categoryData.total;
                });
                resultData.totalScore = totalScore;
                
                console.log('スコア計算完了:', {
                    totalScore: resultData.totalScore,
                    categoryScores: resultData.categoryScores
                });
                
            } catch (error) {
                console.error('スコア計算エラー:', error);
                // フォールバック：固定値を使用
                await calculateResultsFallback(answers);
            }
        }
        
        // フォールバック用計算関数（API失敗時）
        async function calculateResultsFallback(answers) {
            console.warn('フォールバック計算を使用します');
            
            // サンプル質問データ（スプレッドシートと同じ構造）
            const sampleQuestions = [
                {
                    question_id: 'Q001',
                    category: '経営',
                    question_text: '自社の経営戦略に合わせたDX戦略を策定されていますか？ また、戦略は社内に公開、周知され、組織に認知されていますか？',
                    option_1_score: 1, option_2_score: 2, option_3_score: 3, option_4_score: 4
                },
                {
                    question_id: 'Q002',
                    category: '経営',
                    question_text: '将来におけるディスラプションに対する危機感を社内で共有できていますか？',
                    option_1_score: 1, option_2_score: 2, option_3_score: 3, option_4_score: 4
                },
                {
                    question_id: 'Q003',
                    category: '経営',
                    question_text: 'DX推進に対して予算が確保され、ビジネス貢献を評価する仕組みがありますか？',
                    option_1_score: 1, option_2_score: 2, option_3_score: 3, option_4_score: 4
                },
                {
                    question_id: 'Q004',
                    category: '人事',
                    question_text: 'デジタル人材の採用・育成に取り組んでいますか？',
                    option_1_score: 1, option_2_score: 2, option_3_score: 3, option_4_score: 4
                },
                {
                    question_id: 'Q005',
                    category: 'マーケティング',
                    question_text: '顧客データを活用したマーケティング施策を実施していますか？',
                    option_1_score: 1, option_2_score: 2, option_3_score: 3, option_4_score: 4
                }
            ];
            
            resultData.answers = answers;
            resultData.categoryScores = {};
            
            // カテゴリ別スコア計算
            sampleQuestions.forEach(question => {
                const answerIndex = answers[question.question_id];
                if (answerIndex !== null && answerIndex !== undefined && answerIndex >= 0) {
                    let score = 0;
                    switch(answerIndex) {
                        case 0:
                            score = question.option_1_score;
                            break;
                        case 1:
                            score = question.option_2_score;
                            break;
                        case 2:
                            score = question.option_3_score;
                            break;
                        case 3:
                            score = question.option_4_score;
                            break;
                        default:
                            score = 0;
                    }
                    
                    const category = question.category;
                    
                    if (!resultData.categoryScores[category]) {
                        resultData.categoryScores[category] = {
                            total: 0,
                            count: 0,
                            questions: []
                        };
                    }
                    
                    resultData.categoryScores[category].total += score;
                    resultData.categoryScores[category].count += 1;
                    resultData.categoryScores[category].questions.push({
                        questionId: question.question_id,
                        score: score
                    });
                }
            });
            
            // 各カテゴリの平均スコア計算
            Object.keys(resultData.categoryScores).forEach(category => {
                const data = resultData.categoryScores[category];
                data.average = data.total / data.count;
            });
            
            // 総合スコア計算（全スコアの合計）
            let totalScore = 0;
            Object.values(resultData.categoryScores).forEach(categoryData => {
                totalScore += categoryData.total;
            });
            resultData.totalScore = totalScore;
        }
        
        // 結果表示
        function displayResults() {
            console.log('結果表示開始');
            console.log('現在のresultData:', resultData);
            
            // 総合スコア表示（削除済み）
            // document.getElementById('totalScore').textContent = resultData.totalScore;
            
            // 新規: レベル判定と表示
            // 本番用：データがない場合のフォールバック
            if (!resultData.totalScore && resultData.totalScore !== 0) {
                console.warn('totalScoreが未設定のため、デフォルトスコアを使用します');
                resultData.totalScore = 0; // デフォルトスコア（レベル1）
            }
            
            const levelInfo = determineMaturityLevel(resultData.totalScore);
            const summaryText = generateSummaryText(resultData.totalScore, levelInfo.name);
            const descriptionText = getLevelDescription(levelInfo.level);
            
            console.log('レベル判定結果:', levelInfo);
            console.log('サマリー文:', summaryText);
            console.log('解説文:', descriptionText.substring(0, 100) + '...');
            
            // DOM更新
            const summaryElement = document.getElementById('resultSummary');
            const descriptionElement = document.getElementById('levelDescription');
            
            if (summaryElement) {
                summaryElement.textContent = summaryText;
            } else {
                console.error('resultSummary要素が見つかりません');
            }
            
            if (descriptionElement) {
                // 複数段落に分割して表示
                descriptionElement.innerHTML = '';
                const paragraphs = descriptionText.split('\n\n');
                paragraphs.forEach(paragraph => {
                    if (paragraph.trim()) {
                        const p = document.createElement('p');
                        p.textContent = paragraph.trim();
                        p.style.marginBottom = '16px';
                        descriptionElement.appendChild(p);
                    }
                });
            } else {
                console.error('levelDescription要素が見つかりません');
            }
            
            // スコアカード生成（削除済み）
            // generateScoreCards();
            
            // レーダーチャート生成
            generateRadarChart();
        }
        
        // スコアカード生成（削除済み）
        /*
        function generateScoreCards() {
            const container = document.getElementById('scoreCards');
            container.innerHTML = '';
            
            Object.keys(resultData.categoryScores).forEach(category => {
                const data = resultData.categoryScores[category];
                const mapping = categoryMapping[category] || { key: 'other', color: '#666' };
                
                const card = document.createElement('div');
                card.className = 'score-card';
                card.innerHTML = `
                    <div class="score-card-header">
                        <h4 class="score-card-title">${category}</h4>
                        <div class="score-card-value" style="color: ${mapping.color}">
                            ${Math.round(data.average)}<span class="score-unit">点</span>
                        </div>
                    </div>
                    <div class="score-card-progress">
                        <div class="score-progress-bar">
                            <div class="score-progress-fill" style="width: ${data.average}%; background-color: ${mapping.color}"></div>
                        </div>
                    </div>
                    <div class="score-card-details">
                        <span class="score-questions">${data.count}問回答</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        */
        
        // レベル判定ロジック（スプレッドシートのスコア値に基づく）
        function determineMaturityLevel(totalScore) {
            // 実際のスコア範囲に基づいたレベル判定
            // APIから取得した質問数に応じて動的に判定
            // デフォルト：9問×最大4点 = 最大36点を想定
            const maxPossibleScore = 36; // 実際の質問数に応じて調整
            const scorePercentage = (totalScore / maxPossibleScore) * 100;
            
            // パーセンテージベースでレベル判定
            if (scorePercentage <= 25) return { level: 1, name: '業務改善 黎明期' };
            if (scorePercentage <= 50) return { level: 2, name: '業務改善 試行期' };
            if (scorePercentage <= 75) return { level: 3, name: '業務改善 展開期' };
            return { level: 4, name: '業務改善 先進期' };
        }
        
        // レベル別解説文取得
        function getLevelDescription(level) {
            const descriptions = {
                1: `AIやITツールの活用はまだ本格的に始まっていない、もしくは検討段階にあります。
情報収集やツールの知識、具体的な活用アイデアが全体的に不足しており、個人の関心や努力に依存している状態です。見方を変えれば、これから大きく成長できる非常に高いポテンシャルを秘めていると言えます。

まずは経営層を含め、AIやITツールがもたらす業務改善の可能性について共通認識を持つことが第一歩です。他社の成功事例を学ぶ、小規模なセミナーに参加するなど、情報収集から始めましょう。そして、特定の非効率な業務を一つ選び、ツールの試験的な導入を検討することをお勧めします。`,
                
                2: `AIやITツールへの関心は高く、一部の部署や意欲的な個人によってツールの導入や活用が始まっています。しかし、その取り組みはまだ限定的・散発的であり、全社的な動きには至っていません。小さな成功体験と、うまくいかなかった経験が混在している段階です。

個別の成功事例を社内で共有し、横展開する仕組みを作りましょう。業務改善やDXを推進する担当者を正式に任命し、より体系的な情報収集やスキルアップの機会（研修など）を提供することが有効です。外部の専門家の知見も活用し、具体的な業務改善計画の策定に着手するのに最適なタイミングです。`,
                
                3: `複数の部署でAIやITツールの活用が定着し、業務改善の成功事例も増えています。DX推進の担当者やチームが存在し、組織的な取り組みとして活動が進んでいます。一方で、部署ごとに導入したツールが異なったり、部分的な最適化に留まっていたりと、全社的な戦略や連携にはまだ改善の余地がある状態です。

部署ごとに最適化されている業務プロセスやツールを見直し、全社的な視点での標準化やデータ連携を推進する必要があります。専門部署が主導して全社的なDX戦略を策定・実行することで、より大きな成果が期待できます。外部サービスを活用し、高度なツール連携や業務自動化を実現するのも効果的です。`,
                
                4: `経営層の強いコミットメントのもと、全社的にAIやITツールが活用され、業務改善が文化として根付いています。データに基づいた意思決定が浸透し、継続的な改善サイクルが確立されています。市場の変化にも迅速に対応できる、非常に競争力の高い組織状態です。

これまでの成功を継続しつつ、AIが自律的に業務を行う「AIエージェント」や、自社の業務に特化したAIモデルの開発（ファインチューニング）など、より先進的な技術の導入を検討しましょう。業界のリーダーとして、AIを活用した新たなビジネスモデルの創出や、サプライチェーン全体の変革を主導していくことが期待されます。`
            };
            return descriptions[level] || '該当するレベルの解説が見つかりません。';
        }
        
        // サマリー文生成
        function generateSummaryText(totalScore, levelName) {
            return `貴社のAI活用スコアは「${totalScore}」、業務改善ポテンシャルは「${levelName}」となります。`;
        }
        
        // テスト関数（パーセンテージベースのレベル判定用）
        function testLevelLogic() {
            console.log('=== レベル判定テスト開始 ===');
            
            // 各レベルのテストケース（36点満点想定）
            const testCases = [
                { score: 9, expected: 'レベル1 (25%)' },
                { score: 18, expected: 'レベル2 (50%)' }, 
                { score: 27, expected: 'レベル3 (75%)' },
                { score: 36, expected: 'レベル4 (100%)' }
            ];
            
            testCases.forEach(testCase => {
                const result = determineMaturityLevel(testCase.score);
                const summary = generateSummaryText(testCase.score, result.name);
                const description = getLevelDescription(result.level);
                
                console.log(`\nスコア: ${testCase.score} (${testCase.expected})`);
                console.log(`結果: レベル${result.level} - ${result.name}`);
                console.log(`サマリー: ${summary}`);
                console.log(`解説: ${description.substring(0, 100)}...`);
            });
            
            console.log('=== レベル判定テスト完了 ===');
        }
        
        // Step 9: 統合テスト用関数（パーセンテージベース）
        function runIntegrationTests() {
            console.log('🧪 === 統合テスト開始 ===');
            
            // Test Case 1-4: 各レベルでの表示テスト（36点満点想定）
            const testCases = [
                { level: 1, score: 9, name: 'レベル1（業務改善 黎明期）' },
                { level: 2, score: 18, name: 'レベル2（業務改善 試行期）' },
                { level: 3, score: 27, name: 'レベル3（業務改善 展開期）' },
                { level: 4, score: 36, name: 'レベル4（業務改善 先進期）' }
            ];
            
            testCases.forEach((testCase, index) => {
                setTimeout(() => {
                    console.log(`\n🔍 ${testCase.name}テスト開始`);
                    
                    // スコアを設定
                    resultData.totalScore = testCase.score;
                    
                    // レベル判定実行
                    const levelInfo = determineMaturityLevel(testCase.score);
                    const summaryText = generateSummaryText(testCase.score, levelInfo.name);
                    const descriptionText = getLevelDescription(levelInfo.level);
                    
                    // DOM更新
                    const summaryElement = document.getElementById('resultSummary');
                    const descriptionElement = document.getElementById('levelDescription');
                    
                    if (summaryElement) {
                        summaryElement.textContent = summaryText;
                    }
                    
                    if (descriptionElement) {
                        descriptionElement.innerHTML = '';
                        const paragraphs = descriptionText.split('\n\n');
                        paragraphs.forEach(paragraph => {
                            if (paragraph.trim()) {
                                const p = document.createElement('p');
                                p.textContent = paragraph.trim();
                                p.style.marginBottom = '16px';
                                descriptionElement.appendChild(p);
                            }
                        });
                    }
                    
                    console.log(`✅ ${testCase.name}: 表示更新完了`);
                    console.log(`   スコア: ${testCase.score}`);
                    console.log(`   レベル: ${levelInfo.level} - ${levelInfo.name}`);
                    
                    if (index === testCases.length - 1) {
                        setTimeout(() => {
                            console.log('\n🎉 すべてのレベルテスト完了');
                            console.log('📱 モバイル表示確認: F12 > デバイスツールバーでテスト');
                            console.log('🖱️  ボタン動作確認: 各種ボタンをクリックしてテスト');
                        }, 1000);
                    }
                }, index * 3000); // 3秒間隔で実行
            });
        }
        
        // エラーケーステスト
        function testErrorCases() {
            console.log('❌ === エラーケーステスト開始 ===');
            
            // 無効なスコアでのテスト（36点満点想定）
            console.log('🔍 境界値テスト');
            [-1, 0, 9, 10, 18, 19, 27, 28, 36, 40].forEach(score => {
                const levelInfo = determineMaturityLevel(score);
                console.log(`スコア${score}: レベル${levelInfo.level} - ${levelInfo.name}`);
            });
            
            // DOM要素のエラーハンドリングテスト
            console.log('🔍 DOM要素エラーハンドリングテスト');
            const originalSummary = document.getElementById('resultSummary');
            const originalDescription = document.getElementById('levelDescription');
            
            // 一時的に要素を無効化
            if (originalSummary) originalSummary.id = 'temp-summary';
            if (originalDescription) originalDescription.id = 'temp-description';
            
            try {
                displayResults();
                console.log('✅ DOM要素不在時のエラーハンドリング正常');
            } catch (error) {
                console.error('❌ DOM要素エラーハンドリング失敗:', error);
            }
            
            // 要素を復元
            if (originalSummary) originalSummary.id = 'resultSummary';
            if (originalDescription) originalDescription.id = 'levelDescription';
            
            console.log('✅ エラーケーステスト完了');
        }
        
        // レーダーチャート生成
        function generateRadarChart() {
            console.log('チャート生成開始');
            console.log('resultData.categoryScores:', resultData.categoryScores);
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if (!resultData.categoryScores || Object.keys(resultData.categoryScores).length === 0) {
                console.error('カテゴリスコアデータが存在しません');
                return;
            }
            
            // レーダーチャート用のデータ準備
            let labels = Object.keys(resultData.categoryScores);
            let data = labels.map(category => {
                const score = resultData.categoryScores[category];
                // 実際のスコア値を使用（0-100スケールに正規化）
                if (typeof score === 'object') {
                    // 最大値を4として正規化（通常は質問ごとに1-4点）
                    return Math.min(100, (score.average / 4) * 100);
                } else {
                    return Math.min(100, (score / 4) * 100);
                }
            });
            
            // レーダーチャート表示のため、最低3軸必要な場合のダミーデータ追加
            if (labels.length < 3) {
                console.log('レーダーチャート表示のため、ダミーデータを追加');
                const dummyCategories = ['人事', 'マーケティング', '営業', 'IT'];
                const availableDummies = dummyCategories.filter(cat => !labels.includes(cat));
                
                while (labels.length < 5 && availableDummies.length > 0) {
                    const dummyCat = availableDummies.shift();
                    labels.push(dummyCat);
                    data.push(0); // ダミーデータは0点
                }
            }
            
            console.log('チャートラベル（調整後）:', labels);
            console.log('チャートデータ（調整後）:', data);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '現在のスコア',
                        data: data,
                        backgroundColor: 'rgba(74, 144, 226, 0.2)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(74, 144, 226, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(74, 144, 226, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: '#ddd'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 12
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 24,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // サービス詳細を開く
        function openServiceDetail() {
            alert('Haru Automationサービス詳細ページは今後実装予定です。\n現在は概要をご覧いただけます。');
        }
        
        // お問い合わせフォーム開く
        function openContactForm() {
            alert('お問い合わせフォーム機能は Phase 4 で実装予定です');
        }
        
        // 結果ダウンロード
        function downloadResults() {
            const userData = Common.storage.get('userData');
            const resultSummary = {
                company: userData.company,
                name: `${userData.lastName} ${userData.firstName}`,
                totalScore: resultData.totalScore,
                categoryScores: resultData.categoryScores,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(resultSummary, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dx-assessment-result-${userData.company}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            Common.ui.showAlert('診断結果をダウンロードしました', 'success');
        }
        
        // スコア計算のデバッグ関数
        async function debugScoreCalculation(testAnswers) {
            console.log('🔍 === スコア計算デバッグ開始 ===');
            console.log('テスト用回答データ:', testAnswers);
            
            try {
                // APIから質問データを取得してテスト
                console.log('1. API経由でのスコア計算テスト:');
                await calculateResults(testAnswers);
                
                console.log('計算結果:');
                console.log('- 総合スコア:', resultData.totalScore);
                console.log('- カテゴリスコア:', resultData.categoryScores);
                
                // 各質問の詳細なスコア計算を確認
                const questionData = await API.getQuestions();
                const questions = questionData.questions;
                
                let totalScoreCheck = 0;
                console.log('\n2. 各質問のスコア詳細:');
                questions.forEach(question => {
                    const answerIndex = testAnswers[question.question_id];
                    if (answerIndex !== null && answerIndex !== undefined && answerIndex >= 0) {
                        let score = 0;
                        switch(answerIndex) {
                            case 0: score = question.option_1_score || 0; break;
                            case 1: score = question.option_2_score || 0; break;
                            case 2: score = question.option_3_score || 0; break;
                            case 3: score = question.option_4_score || 0; break;
                        }
                        totalScoreCheck += score;
                        console.log(`- ${question.question_id}: 回答${answerIndex + 1} → ${score}点`);
                    }
                });
                
                console.log('\n3. 検算結果:');
                console.log('- 手動計算合計:', totalScoreCheck);
                console.log('- システム計算:', resultData.totalScore);
                console.log('- 一致:', totalScoreCheck === resultData.totalScore ? '✅' : '❌');
                
                // レベル判定確認
                const levelInfo = determineMaturityLevel(resultData.totalScore);
                console.log('\n4. レベル判定:');
                console.log(`- スコア ${resultData.totalScore} → ${levelInfo.name}`);
                
                displayResults();
                
            } catch (error) {
                console.error('デバッグ計算エラー:', error);
                console.log('フォールバック計算でテスト:');
                await calculateResultsFallback(testAnswers);
                displayResults();
            }
            
            console.log('🔍 === スコア計算デバッグ完了 ===');
        }
        
        // 診断をやり直す（Step 7改良版）
        function restartAssessment() {
            if (confirm('診断を最初からやり直しますか？\n現在の結果は失われます。')) {
                try {
                    console.log('診断やり直し処理を開始します');
                    
                    // ストレージをクリア
                    if (Common && Common.storage) {
                        Common.storage.clear();
                        console.log('ローカルストレージをクリアしました');
                    } else {
                        // フォールバック：直接localStorage操作
                        localStorage.clear();
                        sessionStorage.clear();
                        console.log('ストレージを直接クリアしました');
                    }
                    
                    // トップページへ遷移
                    if (Common && Common.navigation) {
                        Common.navigation.goToPage('index.html');
                    } else {
                        // フォールバック：直接遷移
                        window.location.href = 'index.html';
                    }
                    
                } catch (error) {
                    console.error('診断やり直し処理でエラーが発生:', error);
                    alert('エラーが発生しました。ページを手動でリロードしてください。');
                }
            }
        }
    </script>
</body>
</html>