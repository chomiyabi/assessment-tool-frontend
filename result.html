<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診断結果 - DX Web診断</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="container">
            <h1 class="logo">Haru Automation</h1>
        </div>
    </header>
    
    <!-- サブヘッダー -->
    <section class="sub-header">
        <div class="container">
            <h1 class="sub-header-title">業務改善ポテンシャル診断結果</h1>
        </div>
    </section>
    
    <!-- メインコンテンツ -->
    <main class="main">
        <div class="container">
            <div class="result-content">
                
                <!-- 診断結果サマリー -->
                <div class="result-summary-section">
                    <p class="result-summary-text" id="resultSummary">
                        <!-- 動的に生成される文言: 貴社のAI活用スコアは「XXX」、業務改善ポテンシャルは「YYY」となります。 -->
                        診断結果を計算中...
                    </p>
                </div>
                
                <!-- 業務改善ポテンシャル レーダーチャート -->
                <div class="result-chart-section">
                    <h3 class="chart-title">業務改善ポテンシャルの診断結果</h3>
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- レベル詳細解説 -->
                <div class="level-detail-section">
                    <div class="level-description" id="levelDescription">
                        <!-- 動的に生成される詳細解説 -->
                        <p>診断レベルの詳細解説を読み込み中...</p>
                    </div>
                </div>
                
                <!-- ナビゲーションエリア -->
                <div class="navigation-section">
                    <div class="navigation-buttons">
                        <button class="btn btn-outline" onclick="restartAssessment()">
                            診断をやり直す
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Haru Automationサービス紹介エリア（全幅表示） -->
        <div class="service-introduction">
            <div class="service-container">
                <h3 class="service-title">Haru Automation のご紹介</h3>
                <div class="service-content-wrapper">
                    <div class="service-text-column">
                        <div class="service-description">
                            <p class="service-hero-text"><strong>生成AIとあらゆるツールを連携させ、"即成果が出る"自動化を実現します。</strong></p>
                            
                            <p>Haru Automationは、ChatGPTやGeminiなどの生成AIと、ZapierやDify、PowerAutomateといった各種効率化ツールを最適に組み合わせ、お客様専用の業務改善フローを構築します。</p>
                            
                            <p>AI単体では実現できなかった、複雑な業務の自動化や品質向上まで、一気通貫でご支援。「面倒」をなくし、企業のコア業務に集中できる環境を創り出します。</p>
                            
                            <p>高額な初期投資は不要です。まずは<strong>29,800円の「お試しプラン」</strong>で、業務の一つを自動化することによるインパクトを体感してください。効果にご納得いただけた上で、本格的なご支援へとステップアップが可能です。</p>
                            
                            <p>導入後の運用も<strong>「丸投げOK」</strong>のサポート体制で、安心してご利用いただけます。</p>
                        </div>
                        <div class="service-cta-buttons">
                            <button class="btn btn-primary" onclick="openServiceDetail()">
                                サービス詳細を見る
                            </button>
                            <button class="btn btn-secondary" onclick="openContactForm()">
                                お問い合わせ
                            </button>
                        </div>
                    </div>
                    <div class="service-image-column">
                        <img src="assets/haru-automation-hero.png" 
                             alt="Haru Automation サービス概要図 - 各種ツールの自動化連携を示すフロー図" 
                             class="service-hero-image"
                             loading="lazy"
                             onerror="this.style.display='none'">
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- フッター -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Haru All Rights Reserved</p>
        </div>
    </footer>
    
    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/app.js"></script>
    <script src="js/api.js?v=4.2.0"></script>
    <script>
        // 診断結果データ
        let resultData = {
            totalScore: 0,
            categoryScores: {},
            answers: {}
        };
        
        // カテゴリマッピング（本番環境：12問構成）
        const categoryMapping = {
            'Knowledge': { key: 'knowledge', color: '#4A90E2' },
            'Skill': { key: 'skill', color: '#EC892E' },
            'Idea': { key: 'idea', color: '#27AE60' }
        };
        
        // ページ読み込み時の処理
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('P-05: 診断結果ページが読み込まれました');
            
            // 診断データの確認
            const assessmentAnswers = Common.storage.get('assessmentAnswers');
            const userData = Common.storage.get('userData');
            
            if (!assessmentAnswers || !userData) {
                console.error('診断データが見つかりません。最初からやり直してください。');
                alert('診断データが見つかりません。最初からやり直してください。');
                window.location.href = 'index.html';
                return;
            }
            
            // APIから結果を取得するか、ローカルで計算
            if (userData.session_id) {
                try {
                    LoadingHelper.show('少々お待ちください');
                    
                    const apiResult = await API.getResult(userData.session_id);
                    console.log('API結果取得成功:', apiResult);
                    console.log('API category_scores:', apiResult.category_scores);
                    
                    // API結果を使用
                    resultData.totalScore = apiResult.total_score;
                    resultData.maturityLevel = apiResult.maturity_level;
                    resultData.categoryScores = apiResult.category_scores || {};
                    resultData.recommendedServices = apiResult.recommended_services || [];
                    
                    // カテゴリスコアを整形（APIから返されたデータをそのまま使用）
                    const categoryScoresTemp = {};
                    Object.keys(resultData.categoryScores).forEach(category => {
                        const score = resultData.categoryScores[category];
                        // カテゴリごとの質問数を計算（実際の質問データから）
                        let categoryQuestionCount = 0;
                        if (apiResult.questions_by_category && apiResult.questions_by_category[category]) {
                            categoryQuestionCount = apiResult.questions_by_category[category];
                        } else {
                            // デフォルトで推定（経営3問、人事1問、マーケティング1問）
                            if (category === '経営') categoryQuestionCount = 3;
                            else if (category === '人事') categoryQuestionCount = 1;
                            else if (category === 'マーケティング') categoryQuestionCount = 1;
                            else categoryQuestionCount = 1;
                        }
                        
                        categoryScoresTemp[category] = {
                            average: score,
                            total: score,
                            count: categoryQuestionCount
                        };
                    });
                    resultData.categoryScores = categoryScoresTemp;
                    
                    LoadingHelper.hide();
                    displayResults();
                    
                } catch (error) {
                    LoadingHelper.hide();
                    console.error('API結果取得エラー:', error);
                    // 本番環境：API失敗時はエラーメッセージ表示
                    alert('診断結果の取得に失敗しました。しばらく時間をおいてから再度お試しください。');
                    window.location.href = 'index.html';
                }
            } else {
                // 本番環境：セッションIDがない場合はエラー
                console.error('セッションIDが見つかりません');
                alert('セッション情報が見つかりません。最初からやり直してください。');
                window.location.href = 'index.html';
            }
        });
        
        /*
        // ローカル計算ロジック（本番環境では使用しない）
        // 結果計算（本番環境：12問、各0-3点、最大36点）
        async function calculateResults(answers) {
            try {
                // APIから正確な質問データを取得
                const questionData = await API.getQuestions();
                const questions = questionData.questions;
                
                if (!questions || questions.length === 0) {
                    throw new Error('質問データの取得に失敗しました');
                }
                
                resultData.answers = answers;
                resultData.categoryScores = {};
                
                // カテゴリ別スコア計算（12問、各0-3点）
                questions.forEach(question => {
                    const answerIndex = answers[question.question_id];
                    
                    if (answerIndex !== null && answerIndex !== undefined && answerIndex >= 0) {
                        // 本番環境：0-3点のスコア
                        let score = 0;
                        switch(answerIndex) {
                            case 0:
                                score = parseInt(question.option_1_score) || 0;
                                break;
                            case 1:
                                score = parseInt(question.option_2_score) || 1;
                                break;
                            case 2:
                                score = parseInt(question.option_3_score) || 2;
                                break;
                            case 3:
                                score = parseInt(question.option_4_score) || 3;
                                break;
                            default:
                                score = 0;
                        }
                        
                        const category = question.category;
                        
                        if (!resultData.categoryScores[category]) {
                            resultData.categoryScores[category] = {
                                total: 0,
                                count: 0,
                                questions: []
                            };
                        }
                        
                        resultData.categoryScores[category].total += score;
                        resultData.categoryScores[category].count += 1;
                        resultData.categoryScores[category].questions.push({
                            questionId: question.question_id,
                            score: score
                        });
                    }
                });
                
                // 各カテゴリの平均スコア計算（実際のスコア値をそのまま使用）
                Object.keys(resultData.categoryScores).forEach(category => {
                    const data = resultData.categoryScores[category];
                    data.average = data.total / data.count;
                });
                
                // 総合スコア計算（全スコアの合計）
                let totalScore = 0;
                Object.values(resultData.categoryScores).forEach(categoryData => {
                    totalScore += categoryData.total;
                });
                resultData.totalScore = totalScore;
                
                console.log('スコア計算完了:', {
                    totalScore: resultData.totalScore,
                    categoryScores: resultData.categoryScores
                });
                
            } catch (error) {
                console.error('スコア計算エラー:', error);
                // フォールバック：固定値を使用
                await calculateResultsFallback(answers);
            }
        }
        */
        
        /*
        // フォールバック用計算関数（本番環境では使用しない）
        async function calculateResultsFallback(answers) {
            console.error('API接続に失敗しました。本番環境ではフォールバック計算を使用できません。');
            alert('システムエラーが発生しました。しばらく時間をおいてから再度お試しください。');
            window.location.href = 'index.html';
            
            // 本番環境では以下のローカル計算は使用しない
            // console.warn('フォールバック計算を使用します（開発環境のみ）');
            // resultData.answers = answers;
            // resultData.categoryScores = {
            //     'Knowledge': { total: 0, count: 4, average: 0, questions: [] },
            //     'Skill': { total: 0, count: 4, average: 0, questions: [] },
            //     'Idea': { total: 0, count: 4, average: 0, questions: [] }
            // };
            // resultData.totalScore = 0;
        }
        */
        
        // 結果表示
        function displayResults() {
            console.log('結果表示開始');
            console.log('現在のresultData:', resultData);
            
            // 総合スコア表示（削除済み）
            // document.getElementById('totalScore').textContent = resultData.totalScore;
            
            // 新規: レベル判定と表示
            // 本番用：データがない場合のフォールバック
            if (!resultData.totalScore && resultData.totalScore !== 0) {
                console.warn('totalScoreが未設定のため、デフォルトスコアを使用します');
                resultData.totalScore = 0; // デフォルトスコア（レベル1）
            }
            
            const levelInfo = determineMaturityLevel(resultData.totalScore);
            const summaryText = generateSummaryText(resultData.totalScore, levelInfo.name);
            const descriptionText = getLevelDescription(levelInfo.level);
            
            console.log('レベル判定結果:', levelInfo);
            console.log('サマリー文:', summaryText);
            console.log('解説文:', descriptionText.substring(0, 100) + '...');
            
            // DOM更新
            const summaryElement = document.getElementById('resultSummary');
            const descriptionElement = document.getElementById('levelDescription');
            
            if (summaryElement) {
                summaryElement.textContent = summaryText;
            } else {
                console.error('resultSummary要素が見つかりません');
            }
            
            if (descriptionElement) {
                // 複数段落に分割して表示
                descriptionElement.innerHTML = '';
                const paragraphs = descriptionText.split('\n\n');
                paragraphs.forEach(paragraph => {
                    if (paragraph.trim()) {
                        const p = document.createElement('p');
                        p.textContent = paragraph.trim();
                        p.style.marginBottom = '16px';
                        descriptionElement.appendChild(p);
                    }
                });
            } else {
                console.error('levelDescription要素が見つかりません');
            }
            
            // スコアカード生成（削除済み）
            // generateScoreCards();
            
            // レーダーチャート生成
            generateRadarChart();
        }
        
        // スコアカード生成（削除済み）
        /*
        function generateScoreCards() {
            const container = document.getElementById('scoreCards');
            container.innerHTML = '';
            
            Object.keys(resultData.categoryScores).forEach(category => {
                const data = resultData.categoryScores[category];
                const mapping = categoryMapping[category] || { key: 'other', color: '#666' };
                
                const card = document.createElement('div');
                card.className = 'score-card';
                card.innerHTML = `
                    <div class="score-card-header">
                        <h4 class="score-card-title">${category}</h4>
                        <div class="score-card-value" style="color: ${mapping.color}">
                            ${Math.round(data.average)}<span class="score-unit">点</span>
                        </div>
                    </div>
                    <div class="score-card-progress">
                        <div class="score-progress-bar">
                            <div class="score-progress-fill" style="width: ${data.average}%; background-color: ${mapping.color}"></div>
                        </div>
                    </div>
                    <div class="score-card-details">
                        <span class="score-questions">${data.count}問回答</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        */
        
        // レベル判定ロジック（P-05スペック準拠：12問、最大36点）
        function determineMaturityLevel(totalScore) {
            // P-05_DEVELOPMENT_SPEC.md 3.2.3 レベル判定基準
            if (totalScore <= 11) return { level: 1, name: '業務改善 黎明期' };
            if (totalScore <= 23) return { level: 2, name: '業務改善 試行期' };
            if (totalScore <= 32) return { level: 3, name: '業務改善 展開期' };
            return { level: 4, name: '業務改善 先進期' };
        }
        
        // レベル別解説文取得
        function getLevelDescription(level) {
            const descriptions = {
                1: `AIやITツールの活用はまだ本格的に始まっていない、もしくは検討段階にあります。
情報収集やツールの知識、具体的な活用アイデアが全体的に不足しており、個人の関心や努力に依存している状態です。見方を変えれば、これから大きく成長できる非常に高いポテンシャルを秘めていると言えます。

まずは経営層を含め、AIやITツールがもたらす業務改善の可能性について共通認識を持つことが第一歩です。他社の成功事例を学ぶ、小規模なセミナーに参加するなど、情報収集から始めましょう。そして、特定の非効率な業務を一つ選び、ツールの試験的な導入を検討することをお勧めします。`,
                
                2: `AIやITツールへの関心は高く、一部の部署や意欲的な個人によってツールの導入や活用が始まっています。しかし、その取り組みはまだ限定的・散発的であり、全社的な動きには至っていません。小さな成功体験と、うまくいかなかった経験が混在している段階です。

個別の成功事例を社内で共有し、横展開する仕組みを作りましょう。業務改善やDXを推進する担当者を正式に任命し、より体系的な情報収集やスキルアップの機会（研修など）を提供することが有効です。外部の専門家の知見も活用し、具体的な業務改善計画の策定に着手するのに最適なタイミングです。`,
                
                3: `複数の部署でAIやITツールの活用が定着し、業務改善の成功事例も増えています。DX推進の担当者やチームが存在し、組織的な取り組みとして活動が進んでいます。一方で、部署ごとに導入したツールが異なったり、部分的な最適化に留まっていたりと、全社的な戦略や連携にはまだ改善の余地がある状態です。

部署ごとに最適化されている業務プロセスやツールを見直し、全社的な視点での標準化やデータ連携を推進する必要があります。専門部署が主導して全社的なDX戦略を策定・実行することで、より大きな成果が期待できます。外部サービスを活用し、高度なツール連携や業務自動化を実現するのも効果的です。`,
                
                4: `経営層の強いコミットメントのもと、全社的にAIやITツールが活用され、業務改善が文化として根付いています。データに基づいた意思決定が浸透し、継続的な改善サイクルが確立されています。市場の変化にも迅速に対応できる、非常に競争力の高い組織状態です。

これまでの成功を継続しつつ、AIが自律的に業務を行う「AIエージェント」や、自社の業務に特化したAIモデルの開発（ファインチューニング）など、より先進的な技術の導入を検討しましょう。業界のリーダーとして、AIを活用した新たなビジネスモデルの創出や、サプライチェーン全体の変革を主導していくことが期待されます。`
            };
            return descriptions[level] || '該当するレベルの解説が見つかりません。';
        }
        
        // サマリー文生成
        function generateSummaryText(totalScore, levelName) {
            return `貴社のAI活用スコアは「${totalScore}」、業務改善ポテンシャルは「${levelName}」となります。`;
        }
        
        /*
        // テスト関数（開発環境用 - 本番では使用しない）
        function testLevelLogic() {
            console.log('=== レベル判定テスト開始 ===');
            
            // 各レベルのテストケース（P-05スペック準拠）
            const testCases = [
                { score: 5, expected: 'レベル1（0-11点）' },
                { score: 15, expected: 'レベル2（12-23点）' },
                { score: 28, expected: 'レベル3（24-32点）' },
                { score: 35, expected: 'レベル4（33-36点）' }
            ];
            
            testCases.forEach(testCase => {
                const result = determineMaturityLevel(testCase.score);
                const summary = generateSummaryText(testCase.score, result.name);
                const description = getLevelDescription(result.level);
                
                console.log(`\nスコア: ${testCase.score} (${testCase.expected})`);
                console.log(`結果: レベル${result.level} - ${result.name}`);
                console.log(`サマリー: ${summary}`);
                console.log(`解説: ${description.substring(0, 100)}...`);
            });
            
            console.log('=== レベル判定テスト完了 ===');
        }
        */
        
        /*
        // 統合テスト用関数（開発環境用 - 本番では使用しない）
        function runIntegrationTests() {
            console.log('🧪 === 統合テスト開始 ===');
            
            // Test Case 1-4: 各レベルでの表示テスト（P-05スペック準拠）
            const testCases = [
                { level: 1, score: 5, name: 'レベル1（業務改善 黎明期）' },
                { level: 2, score: 15, name: 'レベル2（業務改善 試行期）' },
                { level: 3, score: 28, name: 'レベル3（業務改善 展開期）' },
                { level: 4, score: 35, name: 'レベル4（業務改善 先進期）' }
            ];
            
            testCases.forEach((testCase, index) => {
                setTimeout(() => {
                    console.log(`\n🔍 ${testCase.name}テスト開始`);
                    
                    // スコアを設定
                    resultData.totalScore = testCase.score;
                    
                    // レベル判定実行
                    const levelInfo = determineMaturityLevel(testCase.score);
                    const summaryText = generateSummaryText(testCase.score, levelInfo.name);
                    const descriptionText = getLevelDescription(levelInfo.level);
                    
                    // DOM更新
                    const summaryElement = document.getElementById('resultSummary');
                    const descriptionElement = document.getElementById('levelDescription');
                    
                    if (summaryElement) {
                        summaryElement.textContent = summaryText;
                    }
                    
                    if (descriptionElement) {
                        descriptionElement.innerHTML = '';
                        const paragraphs = descriptionText.split('\n\n');
                        paragraphs.forEach(paragraph => {
                            if (paragraph.trim()) {
                                const p = document.createElement('p');
                                p.textContent = paragraph.trim();
                                p.style.marginBottom = '16px';
                                descriptionElement.appendChild(p);
                            }
                        });
                    }
                    
                    console.log(`✅ ${testCase.name}: 表示更新完了`);
                    console.log(`   スコア: ${testCase.score}`);
                    console.log(`   レベル: ${levelInfo.level} - ${levelInfo.name}`);
                    
                    if (index === testCases.length - 1) {
                        setTimeout(() => {
                            console.log('\n🎉 すべてのレベルテスト完了');
                            console.log('📱 モバイル表示確認: F12 > デバイスツールバーでテスト');
                            console.log('🖱️  ボタン動作確認: 各種ボタンをクリックしてテスト');
                        }, 1000);
                    }
                }, index * 3000); // 3秒間隔で実行
            });
        }
        */
        
        /*
        // エラーケーステスト（開発環境用 - 本番では使用しない）
        function testErrorCases() {
            console.log('❌ === エラーケーステスト開始 ===');
            
            // 境界値テスト（P-05スペック準拠）
            console.log('🔍 境界値テスト');
            [-1, 0, 11, 12, 23, 24, 32, 33, 36, 40].forEach(score => {
                const levelInfo = determineMaturityLevel(score);
                console.log(`スコア${score}: レベル${levelInfo.level} - ${levelInfo.name}`);
            });
            
            // DOM要素のエラーハンドリングテスト
            console.log('🔍 DOM要素エラーハンドリングテスト');
            const originalSummary = document.getElementById('resultSummary');
            const originalDescription = document.getElementById('levelDescription');
            
            // 一時的に要素を無効化
            if (originalSummary) originalSummary.id = 'temp-summary';
            if (originalDescription) originalDescription.id = 'temp-description';
            
            try {
                displayResults();
                console.log('✅ DOM要素不在時のエラーハンドリング正常');
            } catch (error) {
                console.error('❌ DOM要素エラーハンドリング失敗:', error);
            }
            
            // 要素を復元
            if (originalSummary) originalSummary.id = 'resultSummary';
            if (originalDescription) originalDescription.id = 'levelDescription';
            
            console.log('✅ エラーケーステスト完了');
        }
        */
        
        // レーダーチャート生成
        function generateRadarChart() {
            console.log('チャート生成開始');
            console.log('resultData.categoryScores:', resultData.categoryScores);
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if (!resultData.categoryScores || Object.keys(resultData.categoryScores).length === 0) {
                console.error('カテゴリスコアデータが存在しません');
                return;
            }
            
            // レーダーチャート用のデータ準備（絶対値表示：各軸最大12点）
            let labels = Object.keys(resultData.categoryScores);
            let data = labels.map(category => {
                const score = resultData.categoryScores[category];
                console.log(`カテゴリ ${category}:`, score, typeof score);
                // 絶対値を直接使用（0-12点）
                let finalValue;
                if (typeof score === 'object') {
                    finalValue = Math.min(12, score.average || score.total || 0);
                } else {
                    finalValue = Math.min(12, score || 0);
                }
                console.log(`${category} の最終値:`, finalValue);
                return finalValue;
            });
            
            // レーダーチャート表示のため、最低3軸必要な場合のダミーデータ追加
            if (labels.length < 3) {
                console.log('レーダーチャート表示のため、ダミーデータを追加');
                const dummyCategories = ['人事', 'マーケティング', '営業', 'IT'];
                const availableDummies = dummyCategories.filter(cat => !labels.includes(cat));
                
                while (labels.length < 5 && availableDummies.length > 0) {
                    const dummyCat = availableDummies.shift();
                    labels.push(dummyCat);
                    data.push(0); // ダミーデータは0点
                }
            }
            
            console.log('チャートラベル（調整後）:', labels);
            console.log('チャートデータ（絶対値）:', data);
            console.log('元のカテゴリスコア:', resultData.categoryScores);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '現在のスコア',
                        data: data,
                        backgroundColor: 'rgba(74, 144, 226, 0.2)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(74, 144, 226, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(74, 144, 226, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: '#ddd'
                            },
                            min: 0,
                            max: 12,
                            ticks: {
                                stepSize: 3,
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value + '点';
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 24,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // サービス詳細を開く
        function openServiceDetail() {
            alert('Haru Automationサービス詳細ページは今後実装予定です。\n現在は概要をご覧いただけます。');
        }
        
        // お問い合わせフォーム開く
        function openContactForm() {
            alert('お問い合わせフォーム機能は Phase 4 で実装予定です');
        }
        
        // 結果ダウンロード
        function downloadResults() {
            const userData = Common.storage.get('userData');
            const resultSummary = {
                company: userData.company,
                name: `${userData.lastName} ${userData.firstName}`,
                totalScore: resultData.totalScore,
                categoryScores: resultData.categoryScores,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(resultSummary, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dx-assessment-result-${userData.company}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            Common.ui.showAlert('診断結果をダウンロードしました', 'success');
        }
        
        /*
        // スコア計算のデバッグ関数（開発環境用 - 本番では使用しない）
        async function debugScoreCalculation(testAnswers) {
            console.log('🔍 === スコア計算デバッグ開始（開発用） ===');
            
            try {
                await calculateResults(testAnswers);
                console.log('総合スコア:', resultData.totalScore);
                console.log('カテゴリスコア:', resultData.categoryScores);
                
                const levelInfo = determineMaturityLevel(resultData.totalScore);
                console.log(`レベル判定: ${resultData.totalScore}点 → ${levelInfo.name}`);
                
                displayResults();
            } catch (error) {
                console.error('デバッグエラー:', error);
            }
        }
        */
        
        // 診断をやり直す（Step 7改良版）
        function restartAssessment() {
            if (confirm('診断を最初からやり直しますか？\n現在の結果は失われます。')) {
                try {
                    console.log('診断やり直し処理を開始します');
                    
                    // ストレージをクリア
                    if (Common && Common.storage) {
                        Common.storage.clear();
                        console.log('ローカルストレージをクリアしました');
                    } else {
                        // フォールバック：直接localStorage操作
                        localStorage.clear();
                        sessionStorage.clear();
                        console.log('ストレージを直接クリアしました');
                    }
                    
                    // トップページへ遷移
                    if (Common && Common.navigation) {
                        Common.navigation.goToPage('index.html');
                    } else {
                        // フォールバック：直接遷移
                        window.location.href = 'index.html';
                    }
                    
                } catch (error) {
                    console.error('診断やり直し処理でエラーが発生:', error);
                    alert('エラーが発生しました。ページを手動でリロードしてください。');
                }
            }
        }
    </script>
</body>
</html>